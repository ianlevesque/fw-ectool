name: Build and Release Debian Package

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-deb:
    name: Build Debian Package (${{ matrix.ubuntu-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        ubuntu-version:
          - '20.04'  # Ubuntu 20.04 LTS (Focal Fossa) - ESM until 2030
          - '22.04'  # Ubuntu 22.04 LTS (Jammy Jellyfish) - Support until 2027
          - '24.04'  # Ubuntu 24.04 LTS (Noble Numbat) - Support until 2029
          - '25.04'  # Ubuntu 25.04 (Plucky Puffin) - Support until Jan 2026
          - '25.10'  # Ubuntu 25.10 (Questing Quokka) - Latest, Support until Jul 2026

    container:
      image: ubuntu:${{ matrix.ubuntu-version }}
      options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            debhelper \
            devscripts \
            cmake \
            pkg-config \
            libusb-1.0-0-dev \
            libftdi1-dev \
            build-essential \
            git

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b

      - name: List generated files
        run: |
          ls -lh ../*.deb

      - name: Upload Debian package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-package-ubuntu-${{ matrix.ubuntu-version }}
          path: ../*.deb
          retention-days: 30

      - name: Rename package with Ubuntu version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd ..
          for deb in *.deb; do
            if [[ ! "$deb" =~ dbgsym ]]; then
              newname="${deb%.deb}_ubuntu${{ matrix.ubuntu-version }}.deb"
              mv "$deb" "$newname"
              echo "Renamed $deb to $newname"
            fi
          done

      - name: Upload release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ../*.deb
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release-notes:
    name: Create Release Notes
    needs: build-deb
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    steps:
      - name: Update Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ChromeOS EC Tool - Debian Package Release

            This release includes pre-built Debian packages for multiple Ubuntu versions.

            ### Installation

            Download the `.deb` file for your Ubuntu version and install it:

            ```bash
            sudo dpkg -i ectool_*_ubuntu<version>.deb
            sudo apt install -f  # Install any missing dependencies if needed
            ```

            ### Packages Available

            - `ectool_*_ubuntu20.04.deb` - Ubuntu 20.04 LTS (Focal Fossa)
            - `ectool_*_ubuntu22.04.deb` - Ubuntu 22.04 LTS (Jammy Jellyfish)
            - `ectool_*_ubuntu24.04.deb` - Ubuntu 24.04 LTS (Noble Numbat) - Recommended
            - `ectool_*_ubuntu25.04.deb` - Ubuntu 25.04 (Plucky Puffin)
            - `ectool_*_ubuntu25.10.deb` - Ubuntu 25.10 (Questing Quokka) - Latest

            ### Fan Control Commands

            - `ectool autofanctrl <on>` - Enable/disable automatic fan control
            - `ectool fanduty <percent>` - Set manual fan duty cycle (0-100%)
            - `ectool pwmgetfanrpm [<index> | all]` - Get current fan RPM
            - `ectool pwmgetnumfans` - Get number of fans
            - `ectool pwmsetfanrpm <targetrpm>` - Set target fan RPM

            ### Requirements

            - Ubuntu 20.04 or later
            - Debian 10 or later
            - Dependencies: libusb-1.0-0, libftdi1-2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
