name: Build and Release Ubuntu Packages

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

# Minimal permissions by default
permissions:
  contents: read

jobs:
  build-deb:
    name: Build Ubuntu ${{ matrix.ubuntu-version }} Package (${{ matrix.codename }})
    runs-on: ubuntu-latest

    # Only run on PRs from the same repository (not forks) to prevent supply chain attacks
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository

    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - ubuntu-version: '20.04'
            codename: 'focal'
            description: 'Ubuntu 20.04 LTS (Focal Fossa) - ESM until 2030'
          - ubuntu-version: '22.04'
            codename: 'jammy'
            description: 'Ubuntu 22.04 LTS (Jammy Jellyfish) - Support until 2027'
          - ubuntu-version: '24.04'
            codename: 'noble'
            description: 'Ubuntu 24.04 LTS (Noble Numbat) - Support until 2029'
          - ubuntu-version: '25.04'
            codename: 'plucky'
            description: 'Ubuntu 25.04 (Plucky Puffin) - Support until Jan 2026'
          - ubuntu-version: '25.10'
            codename: 'questing'
            description: 'Ubuntu 25.10 (Questing Quokka) - Latest, Support until Jul 2026'

    container:
      image: ubuntu:${{ matrix.ubuntu-version }}
      # Removed --privileged flag - not needed for package building
      # This significantly reduces attack surface

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
        with:
          persist-credentials: false  # Don't persist credentials in workspace

      - name: Install build dependencies
        run: |
          # Update package lists
          apt-get update

          # Install dependencies with explicit versions pinning disabled for now
          # In production, consider pinning specific versions
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            debhelper \
            devscripts \
            cmake \
            pkg-config \
            libusb-1.0-0-dev \
            libftdi1-dev \
            build-essential \
            git \
            ca-certificates

          # Verify critical tools are installed
          command -v dpkg-buildpackage >/dev/null 2>&1 || { echo "dpkg-buildpackage not found"; exit 1; }
          command -v cmake >/dev/null 2>&1 || { echo "cmake not found"; exit 1; }

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b

      - name: Move and verify packages
        run: |
          mkdir -p packages
          mv ../*.deb packages/ || true

          # Verify at least one package was built
          if [ ! -f packages/*.deb ]; then
            echo "Error: No .deb packages found"
            exit 1
          fi

          ls -lh packages/

      - name: Rename package with Ubuntu codename
        shell: bash
        run: |
          cd packages
          for deb in *.deb; do
            case "$deb" in
              *dbgsym*)
                echo "Skipping debug package: $deb"
                ;;
              *)
                newname="${deb%.deb}_${{ matrix.codename }}.deb"
                mv "$deb" "$newname"
                echo "Renamed $deb to $newname"
                ;;
            esac
          done

          # Generate checksums after renaming
          sha256sum *.deb > SHA256SUMS
          cat SHA256SUMS
          ls -lh

      - name: Upload Debian package as artifact
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8  # v4.3.0
        with:
          name: debian-package-${{ matrix.codename }}
          path: |
            packages/*.deb
            packages/SHA256SUMS
          retention-days: 7  # Reduced from 30 days
          if-no-files-found: error  # Fail if no files found

  release:
    name: Create GitHub Release
    needs: build-deb
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Only this job needs write access

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Copy all .deb files, preserving the renamed files with codenames
          find artifacts -name "*.deb" -type f | while read file; do
            cp -v "$file" release/
          done

          # Combine all SHA256SUMS files
          find artifacts -name "SHA256SUMS" -exec cat {} \; > release/SHA256SUMS

          echo "Release contents:"
          ls -lh release/
          echo ""
          echo "Total packages: $(ls -1 release/*.deb 2>/dev/null | wc -l)"

      - name: Upload release assets
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090  # v2.4.1
        with:
          files: release/*
          draft: false
          prerelease: false
          fail_on_unmatched_files: true  # Changed to true for safety
          generate_release_notes: true
          body: |
            ## ectool for Framework Laptops - Ubuntu Package Release

            This release includes pre-built Ubuntu packages for multiple versions.

            ### Installation

            Download the `.deb` file for your Ubuntu version and install it:

            ```bash
            # Download the package and checksum file
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ectool_*_<codename>.deb
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/SHA256SUMS

            # Verify checksum
            sha256sum -c SHA256SUMS --ignore-missing

            # Install
            sudo dpkg -i ectool_*_<codename>.deb
            sudo apt install -f  # Install any missing dependencies if needed
            ```

            ### Packages Available

            - `ectool_*_focal.deb` - Ubuntu 20.04 LTS (Focal Fossa)
            - `ectool_*_jammy.deb` - Ubuntu 22.04 LTS (Jammy Jellyfish)
            - `ectool_*_noble.deb` - Ubuntu 24.04 LTS (Noble Numbat) - Recommended
            - `ectool_*_plucky.deb` - Ubuntu 25.04 (Plucky Puffin)
            - `ectool_*_questing.deb` - Ubuntu 25.10 (Questing Quokka) - Latest

            ### Fan Control Commands

            - `ectool autofanctrl <on>` - Enable/disable automatic fan control
            - `ectool fanduty <percent>` - Set manual fan duty cycle (0-100%)
            - `ectool pwmgetfanrpm [<index> | all]` - Get current fan RPM
            - `ectool pwmgetnumfans` - Get number of fans
            - `ectool pwmsetfanrpm <targetrpm>` - Set target fan RPM

            ### Requirements

            - Ubuntu 20.04 or later
            - Dependencies: libusb-1.0-0, libftdi1-2

            ### Build Information

            - Built with GitHub Actions
            - Source: ${{ github.repository }}@${{ github.ref_name }}
            - Commit: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
