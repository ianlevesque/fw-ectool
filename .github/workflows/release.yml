name: Build and Release Debian Package

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debhelper \
            devscripts \
            cmake \
            pkg-config \
            libusb-1.0-0-dev \
            libftdi1-dev \
            build-essential

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b

      - name: List generated files
        run: |
          ls -lh ../*.deb

      - name: Upload Debian package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: ../*.deb
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ../*.deb
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ChromeOS EC Tool - Debian Package Release

            This release includes a pre-built Debian package for Ubuntu/Debian systems.

            ### Installation

            Download the `.deb` file and install it:

            ```bash
            sudo dpkg -i ectool_*.deb
            sudo apt install -f  # Install any missing dependencies
            ```

            ### Fan Control Commands

            - `ectool autofanctrl <on>` - Enable/disable automatic fan control
            - `ectool fanduty <percent>` - Set manual fan duty cycle (0-100%)
            - `ectool pwmgetfanrpm [<index> | all]` - Get current fan RPM
            - `ectool pwmgetnumfans` - Get number of fans
            - `ectool pwmsetfanrpm <targetrpm>` - Set target fan RPM

            ### Requirements

            - Ubuntu 20.04 or later
            - Debian 10 or later
            - Dependencies: libusb-1.0-0, libftdi1-2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
