name: Build and Release Ubuntu Packages

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-deb:
    name: Build Ubuntu ${{ matrix.ubuntu-version }} Package (${{ matrix.codename }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - ubuntu-version: '20.04'
            codename: 'focal'
            description: 'Ubuntu 20.04 LTS (Focal Fossa) - ESM until 2030'
          - ubuntu-version: '22.04'
            codename: 'jammy'
            description: 'Ubuntu 22.04 LTS (Jammy Jellyfish) - Support until 2027'
          - ubuntu-version: '24.04'
            codename: 'noble'
            description: 'Ubuntu 24.04 LTS (Noble Numbat) - Support until 2029'
          - ubuntu-version: '25.04'
            codename: 'plucky'
            description: 'Ubuntu 25.04 (Plucky Puffin) - Support until Jan 2026'
          - ubuntu-version: '25.10'
            codename: 'questing'
            description: 'Ubuntu 25.10 (Questing Quokka) - Latest, Support until Jul 2026'

    container:
      image: ubuntu:${{ matrix.ubuntu-version }}
      options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            debhelper \
            devscripts \
            cmake \
            pkg-config \
            libusb-1.0-0-dev \
            libftdi1-dev \
            build-essential \
            git

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b

      - name: Move packages to workspace
        run: |
          mkdir -p packages
          mv ../*.deb packages/ || true
          ls -lh packages/

      - name: Upload Debian package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-package-${{ matrix.codename }}
          path: packages/*.deb
          retention-days: 30

      - name: Rename package with Ubuntu codename
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd packages
          for deb in *.deb; do
            if [[ ! "$deb" =~ dbgsym ]]; then
              newname="${deb%.deb}_${{ matrix.codename }}.deb"
              mv "$deb" "$newname"
              echo "Renamed $deb to $newname"
            fi
          done
          ls -lh

      - name: Upload release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: packages/*.deb
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release-notes:
    name: Create Ubuntu Package Release Notes
    needs: build-deb
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    steps:
      - name: Update Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ectool for Framework Laptops - Ubuntu Package Release

            This release includes pre-built Ubuntu packages for multiple versions.

            ### Installation

            Download the `.deb` file for your Ubuntu version and install it:

            ```bash
            sudo dpkg -i ectool_*_<codename>.deb
            sudo apt install -f  # Install any missing dependencies if needed
            ```

            ### Packages Available

            - `ectool_*_focal.deb` - Ubuntu 20.04 LTS (Focal Fossa)
            - `ectool_*_jammy.deb` - Ubuntu 22.04 LTS (Jammy Jellyfish)
            - `ectool_*_noble.deb` - Ubuntu 24.04 LTS (Noble Numbat) - Recommended
            - `ectool_*_plucky.deb` - Ubuntu 25.04 (Plucky Puffin)
            - `ectool_*_questing.deb` - Ubuntu 25.10 (Questing Quokka) - Latest

            ### Fan Control Commands

            - `ectool autofanctrl <on>` - Enable/disable automatic fan control
            - `ectool fanduty <percent>` - Set manual fan duty cycle (0-100%)
            - `ectool pwmgetfanrpm [<index> | all]` - Get current fan RPM
            - `ectool pwmgetnumfans` - Get number of fans
            - `ectool pwmsetfanrpm <targetrpm>` - Set target fan RPM

            ### Requirements

            - Ubuntu 20.04 or later
            - Debian 10 or later
            - Dependencies: libusb-1.0-0, libftdi1-2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
